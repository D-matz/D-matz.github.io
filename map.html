<!DOCTYPE html> 
<html lang="en"> 
<head> 
	<title>Eat The World</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20100%20100'%3e%3cdefs%3e%3clinearGradient%20id='blue-gradient'%20x1='0%25'%20y1='0%25'%20x2='100%25'%20y2='100%25'%3e%3cstop%20offset='0%25'%20stop-color='%23A6D7F0'/%3e%3cstop%20offset='100%25'%20stop-color='%23023E58'/%3e%3c/linearGradient%3e%3c/defs%3e%3ccircle%20cx='50'%20cy='50'%20r='50'%20fill='url(%23blue-gradient)'/%3e%3c/svg%3e" type="image/svg+xml" />
    <script src="d3.v4.min.js"></script> 
    <script src="d3-geo-projection.v2.min.js"></script>
	<link rel="stylesheet" href="style.css">
	<script src="common_loadtheme.js"></script>
</head>
<body>
  <div id="nav" style="display: flex; justify-content: center; align-items: center; padding: 10px;">
    <a title="globe (3D)" href="/globe.html">ğŸŒ</a>
    <a title="map (2D)" href="/map.html">ğŸ—ºï¸</a>
    <a title="list (uh...it's a list)" href="/list.html">ğŸ“„</a>
	
	<input list="countries" type="text" id="searchCountry" placeholder="ğŸ”">
	<datalist id="countries"> <option value="South Korea"> <option value="Cambodia"> <option value="Kosovo"> </datalist>
    
	<button onclick="toggleTheme()"
      style="margin-left: 10px; height: 25px;"
      class="theme-switcher-grid"
      id="theme-switcher-grid"
      aria-label="Switch theme"
    >
      <div class="sun" id="sun" aria-hidden="true"></div>
      <div class="moon-overlay" id="moon-overlay" aria-hidden="true"></div>
      <div class="cloud-ball cloud-ball-left" id="ball1" aria-hidden="true"></div>
      <div class="cloud-ball cloud-ball-middle" id="ball2" aria-hidden="true"></div>
      <div class="cloud-ball cloud-ball-right" id="ball3" aria-hidden="true"></div>
      <div class="cloud-ball cloud-ball-top" id="ball4" aria-hidden="true"></div>
      <div class="star" id="star1" aria-hidden="true"></div>
      <div class="star" id="star2" aria-hidden="true"></div>
      <div class="star" id="star3" aria-hidden="true"></div>
      <div class="star" id="star4" aria-hidden="true"></div>
    </button>
  </div>

  <div style="flex-grow: 1; display: flex; justify-content: center; align-items: center;">
	<svg style="width: min(90vh * 1.68766789, 90vw); height: min(90vh, 90vw / 1.68766789);"></svg>
  </div>

	<script src="common_tooltip.js"></script>
    <script> 
const aspectRatio = 1.68766789;
let svg = d3.select("svg");
let projection = d3.geoWinkel3();
let path = d3.geoPath().projection(projection);
let countriesGroup, ocean;

const zoom = d3.zoom()
  .scaleExtent([0.5, 8])
  .filter(function() {
    if (d3.event.type === "wheel") return true;
    if (d3.event.type === "mousedown") return d3.event.target.tagName === "rect";
    return true;
  })
  .on("start", function() {
    d3.select(this).style("cursor", "grabbing");
    svg.selectAll("path").style("pointer-events", "none");
    hideTooltip();
  })
	.on("end", function() {
		d3.select(this).style("cursor", "grab");
		svg.selectAll("path").style("pointer-events", "auto");
	})
  .on("zoom", function() {
    countriesGroup.attr("transform", d3.event.transform);
    svg.select("rect").attr("transform", d3.event.transform);
  });


function updateScale() {
  const mapHeight = Math.min(window.innerHeight * 0.9, window.innerWidth * 0.9 / aspectRatio);
  const mapWidth = mapHeight * aspectRatio;
  
  svg.attr("width", mapWidth).attr("height", mapHeight);
  projection.scale(mapHeight * 0.3).translate([mapWidth / 2, mapHeight / 2]);
  path.projection(projection);
  
  // Only update if elements exist
  if (ocean && countriesGroup) {
    // Use the existing data instead of reloading
    const bounds = path.bounds({ 
      type: "FeatureCollection", 
      features: countriesGroup.selectAll("path").data() 
    });
    const [[x0, y0], [x1, y1]] = bounds;
    const padX = (x1 - x0) * 0.01;
    
    ocean
      .attr("x", x0 - padX)
      .attr("y", y0)
      .attr("width", (x1 - x0) + padX * 2)
      .attr("height", y1 - y0)
      .attr("rx", (y1 - y0) / 2)
      .attr("ry", (y1 - y0) / 2);
      
    countriesGroup.selectAll("path").attr("d", path);
  }
}

d3.json("/colored_world.json", function(data) {
  // Calculate initial bounds
  let [[x0, y0], [x1, y1]] = path.bounds({ type: "FeatureCollection", features: data.features });
  let padX = (x1 - x0) * 0.01;
  
  // Create ocean background
  ocean = svg.insert("rect", ":first-child")
    .attr("x", x0 - padX)
    .attr("y", y0)
    .attr("width", (x1 - x0) + padX * 2)
    .attr("height", y1 - y0)
    .attr("rx", (y1 - y0) / 2)
    .attr("ry", (y1 - y0) / 2)
    .attr("fill", "var(--ocean-color)")
    .attr("style", "transition: fill 0.8s ease;");
  
  // Create countries
  countriesGroup = svg.append("g");
  countriesGroup.selectAll("path")
    .data(data.features)
    .enter().append("path")
    .attr("d", path)
    .attr("fill", d => `var(--country-${['one','two','three','four'][d.properties.color - 1]})`)
    .style("cursor", "pointer")
	.on("click", function(d) {
	if (pinnedCountry === d) {
		// Clicking same country - unpin
		hideTooltip();
	} else {
		// Pin new country
		pinnedCountry = d;
		showTooltip(d, d3.event);
	}
	})
	.on("mouseover", d => { if (!pinnedCountry) showTooltip(d, d3.event); })
	.on("mouseout", () => { if (!pinnedCountry) hideTooltip(); })
	.on("mousemove", () => { if (!pinnedCountry) showTooltip(null, d3.event); }); 
    
  svg.call(zoom);
  updateScale();
	window.addEventListener("resize", updateScale);
});

    </script> 
		<script src="common_toggletheme.js"></script>

</body>
  
</html>