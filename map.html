<!DOCTYPE html> 
<html lang="en"> 
  
<head> 
    <meta charset="UTF-8" /> 
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
	<title>Eat The World</title>
  <link rel="icon" href="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20100%20100'%3e%3cdefs%3e%3clinearGradient%20id='blue-gradient'%20x1='0%25'%20y1='0%25'%20x2='100%25'%20y2='100%25'%3e%3cstop%20offset='0%25'%20stop-color='%23A6D7F0'/%3e%3cstop%20offset='100%25'%20stop-color='%23023E58'/%3e%3c/linearGradient%3e%3c/defs%3e%3ccircle%20cx='50'%20cy='50'%20r='50'%20fill='url(%23blue-gradient)'/%3e%3c/svg%3e" type="image/svg+xml" />
    <script src="https://d3js.org/d3.v4.js"></script> 
    <script src=
"https://d3js.org/d3-geo-projection.v2.min.js">
    </script>
	<link rel="stylesheet" href="style.css">
</head>
<body> 
<div style="display: flex; flex-direction: column; min-height: 100vh;">
  <div id="nav" style="display: flex; align-items: center; padding: 10px;">
    <a title="globe" href="/globe.html">🌎</a>
    <a title="map" href="/map.html">🗺️</a>
    <a title="list" href="/list.html">📄</a>
    <button
      style="margin-left: 10px; height: 25px;"
      class="theme-switcher-grid"
      id="theme-switcher-grid"
      aria-label="Switch theme"
    >
      <div class="sun" id="sun" aria-hidden="true"></div>
      <div class="moon-overlay" id="moon-overlay" aria-hidden="true"></div>
      <div class="cloud-ball cloud-ball-left" id="ball1" aria-hidden="true"></div>
      <div class="cloud-ball cloud-ball-middle" id="ball2" aria-hidden="true"></div>
      <div class="cloud-ball cloud-ball-right" id="ball3" aria-hidden="true"></div>
      <div class="cloud-ball cloud-ball-top" id="ball4" aria-hidden="true"></div>
      <div class="star" id="star1" aria-hidden="true"></div>
      <div class="star" id="star2" aria-hidden="true"></div>
      <div class="star" id="star3" aria-hidden="true"></div>
      <div class="star" id="star4" aria-hidden="true"></div>
    </button>
  </div>

  <div style="flex-grow: 1; display: flex; justify-content: center; align-items: center;">
	<svg style="width: min(90vh * 1.68766789, 90vw); height: min(90vh, 90vw / 1.68766789);"></svg>
  </div>
</div>


  	<script src="common.js"></script>
    <script> 
const aspectRatio = 1.68766789;
let svg = d3.select("svg");
let projection = d3.geoWinkel3();
let path = d3.geoPath().projection(projection);
let countriesGroup, ocean;

const zoom = d3.zoom()
  .scaleExtent([0.5, 8])
  .filter(function() {
    if (d3.event.type === "wheel") return true;
    if (d3.event.type === "mousedown") return d3.event.target.tagName === "rect";
    return true;
  })
  .on("start", function() {
    d3.select(this).style("cursor", "grabbing");
    svg.selectAll("path").style("pointer-events", "none");
    hideTooltip();
  })
	.on("end", function() {
		d3.select(this).style("cursor", "grab");
		svg.selectAll("path").style("pointer-events", "auto");
	})
  .on("zoom", function() {
    countriesGroup.attr("transform", d3.event.transform);
    svg.select("rect").attr("transform", d3.event.transform);
  });
  
svg.call(zoom);


function updateScale() {
  const mapHeight = Math.min(window.innerHeight * 0.9, window.innerWidth * 0.9 / aspectRatio);
  const mapWidth = mapHeight * aspectRatio;

  svg.attr("width", mapWidth)
     .attr("height", mapHeight);

  projection
    .scale(mapHeight * 0.3)
    .translate([mapWidth / 2, mapHeight / 2]);

  path.projection(projection);

  if (ocean && countriesGroup) {
    // Update ocean rect bounds using current projection & features
    d3.json("/colored_world.json", function(data) {
      const [[x0, y0], [x1, y1]] = path.bounds({ type: "FeatureCollection", features: data.features });
      const padX = (x1 - x0) * 0.01;

      ocean
        .attr("x", x0 - padX)
        .attr("y", y0)
        .attr("width", (x1 - x0) + padX * 2)
        .attr("height", y1 - y0)
        .attr("rx", (y1 - y0) / 2)
        .attr("ry", (y1 - y0) / 2);

      countriesGroup.selectAll("path")
        .attr("d", path);
    });
  }
  
  svg.call(zoom.transform, d3.zoomIdentity);
}

d3.json("/colored_world.json", function(data) {
  const [[x0, y0], [x1, y1]] = path.bounds({ type: "FeatureCollection", features: data.features });
  const padX = (x1 - x0) * 0.01;

  ocean = svg.insert("rect", ":first-child")
    .attr("x", x0 - padX)
    .attr("y", y0)
    .attr("width", (x1 - x0) + padX * 2)
    .attr("height", y1 - y0)
    .attr("rx", (y1 - y0) / 2)
    .attr("ry", (y1 - y0) / 2)
    .attr("fill", "var(--ocean-color-light)")
    .attr("style", "transition: fill 0.8s ease;");

  countriesGroup = svg.append("g");

  countriesGroup.selectAll("path")
    .data(data.features)
    .enter().append("path")
    .attr("d", path)
    .attr("fill", d => `var(--country-${['one','two','three','four'][d.properties.color - 1]})`)
    .style("cursor", "pointer")
    .on("click", function(d) {
      if (pinnedCountry === d) hideTooltip();
      else { pinnedCountry = d; showTooltip(d, d3.event); }
    })
    .on("mouseover", function(d) {
      if (!pinnedCountry) showTooltip(d, d3.event);
    })
    .on("mouseout", function() {
      if (!pinnedCountry) hideTooltip();
    })
    .on("mousemove", function() {
      if (!pinnedCountry) showTooltip(null, d3.event);
    });	
  svg.call(zoom);
  updateScale();               // initial sizing
  window.addEventListener("resize", updateScale);
});

    </script> 
</body>
  
</html>