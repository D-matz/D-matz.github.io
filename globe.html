<!DOCTYPE html> 
<html lang="en"> 
<head> 
	<title>Eat The World</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20100%20100'%3e%3cdefs%3e%3clinearGradient%20id='blue-gradient'%20x1='0%25'%20y1='0%25'%20x2='100%25'%20y2='100%25'%3e%3cstop%20offset='0%25'%20stop-color='%23A6D7F0'/%3e%3cstop%20offset='100%25'%20stop-color='%23023E58'/%3e%3c/linearGradient%3e%3c/defs%3e%3ccircle%20cx='50'%20cy='50'%20r='50'%20fill='url(%23blue-gradient)'/%3e%3c/svg%3e" type="image/svg+xml" />
    <script src="d3.v4.min.js"></script> 
    <script src="d3-geo-projection.v2.min.js"></script>
	<link rel="stylesheet" href="style.css">
	<script src="common_loadtheme.js"></script>
</head>
<body>
  <div id="nav" style="display: flex; justify-content: center; align-items: center; padding: 10px;">
    <a title="globe (3D)" href="/globe.html">üåé</a>
    <a title="map (2D)" href="/map.html">üó∫Ô∏è</a>
    <a title="list (uh...it's a list)" href="/list.html">üìÑ</a>
	
	<input list="countries" type="text" id="searchCountry" placeholder="üîç">
	<datalist id="countries"> <option value="South Korea"> <option value="Cambodia"> <option value="Kosovo"> </datalist>
	
    <button onclick="toggleTheme()"
      style="margin-left: 10px; height: 25px;"
      class="theme-switcher-grid"
      id="theme-switcher-grid"
      aria-label="Switch theme"
    >
      <div class="sun" id="sun" aria-hidden="true"></div>
      <div class="moon-overlay" id="moon-overlay" aria-hidden="true"></div>
      <div class="cloud-ball cloud-ball-left" id="ball1" aria-hidden="true"></div>
      <div class="cloud-ball cloud-ball-middle" id="ball2" aria-hidden="true"></div>
      <div class="cloud-ball cloud-ball-right" id="ball3" aria-hidden="true"></div>
      <div class="cloud-ball cloud-ball-top" id="ball4" aria-hidden="true"></div>
      <div class="star" id="star1" aria-hidden="true"></div>
      <div class="star" id="star2" aria-hidden="true"></div>
      <div class="star" id="star3" aria-hidden="true"></div>
      <div class="star" id="star4" aria-hidden="true"></div>
    </button>
  </div>
  
  <div style="flex-grow: 1; display: flex; justify-content: center; align-items: center;">
    <svg style="width: min(90vh, 90vw); height: min(90vh, 90vw);">
    </svg>
  </div>

	<script src="common_tooltip.js"></script>
    <script> 
		const size = Math.min(window.innerHeight * 0.9, window.innerWidth * 0.9);
		var svg = d3.select("svg")
			.attr("width", size)
			.attr("height", size);
		const width = size;
		const height = size;
		
		// The orthographic Earth projection 
		// Center(0,0) and no rotation 
		var projection = d3.geoOrthographic()
			.center([0, 0]) 
			.scale(size * 0.5)
			.clipAngle(90 )
			.translate([width / 2, height / 2]) 
			.rotate([0,0])

		const path = d3.geoPath().projection(projection);

		// Add ocean background
		const ocean = svg.append("circle")
			.attr("cx", width / 2)
			.attr("cy", height / 2)
			.attr("r", size * 0.5)
			.attr("fill", "var(--ocean-color)")
			.attr("style", "transition: fill 0.8s ease; cursor: grab;")

		// Add drag behavior
		const drag = d3.drag()
			.on("start", function() {
				d3.select(this).style("cursor", "grabbing");
				svg.selectAll("path").style("pointer-events", "none");
				hideTooltip();
			})
			.on("drag", function() {
				const rotate = projection.rotate();
				const k = 75 / projection.scale();
				const yaw = rotate[0] + d3.event.dx * k * Math.cos(rotate[1] * Math.PI / 180);
				const pitch = rotate[1] - d3.event.dy * k;
				projection.rotate([yaw, pitch]);
				svg.selectAll("path").attr("d", path);
			})
			.on("end", function() {
				d3.select(this).style("cursor", "grab");
				svg.selectAll("path").style("pointer-events", "auto");
			});

		ocean.call(drag); // Apply drag only to ocean circle


		// Loading data from json
		d3.json("/colored_world.json", 
			function (data) { 
				// Draw the map 
				svg.append("g") 
					.selectAll("path") 
					.data(data.features) 
					.enter().append("path")
					.attr("d", d3.geoPath() 
						.projection(projection) 
					)
					.attr("fill", d => `var(--country-${['one','two','three','four'][d.properties.color - 1]})`)
					.style("cursor", "pointer")
					.on("click", function(d) {
						if (pinnedCountry === d) {
							// Clicking same country - unpin
							hideTooltip();
						} else {
							// Pin new country
							pinnedCountry = d;
							showTooltip(d, d3.event);
						}
					})
				.on("mouseover", d => { if (!pinnedCountry) showTooltip(d, d3.event); })
				.on("mouseout", () => { if (!pinnedCountry) hideTooltip(); })
				.on("mousemove", () => { if (!pinnedCountry) showTooltip(null, d3.event); });
		})
		
		// Zoom behavior for scroll wheel zooming
		const initialScale = projection.scale();
		const zoom = d3.zoom()
			.scaleExtent([initialScale * 0.5, initialScale * 4])
			.on("zoom", function () {
				const newScale = d3.event.transform.k;
				projection.scale(newScale);
				ocean.attr("r", newScale);
				svg.selectAll("path").attr("d", path);
				hideTooltip();
			});

		svg.call(zoom).call(zoom.transform, d3.zoomIdentity.scale(initialScale));

		function updateScale() {
			const newSize = Math.min(window.innerHeight * 0.9, window.innerWidth * 0.9);
			
			// Update SVG dimensions
			svg.attr("width", newSize)
			   .attr("height", newSize);
			
			// Update projection with new scale and translate
			projection.scale(newSize * 0.5)
					  .translate([newSize / 2, newSize / 2]);
			
			// Redraw all paths with updated projection
			svg.selectAll("path").attr("d", path);
			
			// Update any other elements that depend on size (circles, etc.)
			svg.selectAll("circle")
			   .attr("cx", newSize / 2)
			   .attr("cy", newSize / 2)
			   .attr("r", newSize * 0.5);
		}

		// Add resize event listener
		window.addEventListener('resize', updateScale);

    </script> 
	<script src="common_toggletheme.js"></script>
</body>
  
</html>